#!/usr/bin/env bash

if [[ ${VARNISH_AUTOSTART_VARNISHD_WRAPPER} == false ]] \
	&& [[ ${VARNISH_AUTOSTART_VARNISHNCSA_WRAPPER} == false ]]
then
	exit 0
fi

# varnishd-wrapper
if [[ ${VARNISH_AUTOSTART_VARNISHD_WRAPPER} == true ]] \
	&& ! ps axo command \
	| grep -qE '^/usr/sbin/varnishd '
then
	printf -- \
		"Process varnishd not running."
	exit 1
fi

# ready status
if [[ ${VARNISH_AUTOSTART_VARNISHD_WRAPPER} == true ]] \
	&& ! varnishadm vcl.show -v boot \
	&> /dev/null
then
	printf -- \
		"Varnish not booted."
	exit 1
fi

# varnishncsa-wrapper
if [[ ${VARNISH_AUTOSTART_VARNISHNCSA_WRAPPER} == true ]] \
	&& ! ps axo command \
	| grep -qE '^/usr/bin/varnishncsa '
then
	printf -- \
		"Process varnishncsa not running."
	exit 1
fi

exit 0
