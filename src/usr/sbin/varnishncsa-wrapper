#!/usr/bin/env bash

readonly BIN="/usr/bin/varnishncsa"
readonly FORMAT="${VARNISH_VARNISHNCSA_FORMAT:-"%h %l %u %t \"%r\" %s %b \"%{Referer}i\" \"%{User-agent}i\""}"
readonly LOCK_FILE="/var/lock/subsys/varnishd-wrapper"
readonly NICE="/bin/nice"
readonly NICENESS="10"
readonly OPTIONS="-a
 -c
 -P /var/run/varnish/varnishncsa.pid
"

while true
do
	sleep 0.1
	[[ -e ${LOCK_FILE} ]] || break
done

exec ${NICE} \
	-n ${NICENESS} \
	${BIN} \
	${OPTIONS} \
	-F "${FORMAT}"
